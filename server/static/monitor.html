<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>模型输出监控</title>
  <style>
    body { background:#0b0f14; color:#cfe3ff; font-family:Segoe UI,Arial; margin:0 }
    header { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid #24415f }
    .badge { padding:4px 8px; border:1px solid #406a9a; border-radius:6px; font-size:12px }
    #controls { display:flex; gap:8px; align-items:center }
    input,select,button { background:#0f1620; color:#cfe3ff; border:1px solid #24415f; padding:8px; border-radius:6px }
    button { cursor:pointer }
    main { display:grid; grid-template-columns: 1fr 300px; gap:12px; padding:12px }
    #stream { background:#0f1620; border:1px solid #24415f; border-radius:8px; padding:8px; height:70vh; overflow:auto }
    #stream .item { border-bottom:1px solid #1c2b3d; padding:8px 4px }
    #stream .meta { font-size:12px; color:#9db7d1 }
    #timeline { background:#0f1620; border:1px solid #24415f; border-radius:8px; padding:8px; height:70vh; overflow:auto }
    #status { padding:4px 16px; font-size:12px; color:#9db7d1 }
  </style>
</head>
<body>
  <header>
    <div class="badge">模型输出监控</div>
    <div id="controls">
      <input id="q" placeholder="搜索输出内容/模型/项目ID" />
      <select id="type">
        <option value="">全部类型</option>
        <option>文本</option>
        <option>图像</option>
      </select>
      <button id="export">导出JSON</button>
    </div>
    <div style="flex:1"></div>
    <div id="status">未连接</div>
  </header>
  <main>
    <div id="stream"></div>
    <div id="timeline"></div>
  </main>
  <script>
    const params = new URLSearchParams(location.search);
    const apiKey = params.get('api_key') || '';
    const ws = new WebSocket(`${location.origin.replace('http','ws')}/api/v1/monitor/ws?api_key=${apiKey}`);
    const stream = document.getElementById('stream');
    const timeline = document.getElementById('timeline');
    const status = document.getElementById('status');
    const q = document.getElementById('q');
    const typeSel = document.getElementById('type');
    const exportBtn = document.getElementById('export');
    const buffer = [];

    function render() {
      const term = (q.value || '').toLowerCase();
      const type = typeSel.value;
      stream.innerHTML = '';
      buffer
        .filter(x => (!term || JSON.stringify(x).toLowerCase().includes(term)))
        .filter(x => (!type || (x.type||'文本') === type))
        .forEach(x => {
          const div = document.createElement('div');
          div.className = 'item';
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.textContent = `${x.timestamp} | 模型:${x.model} | 项目:${x.project_id} | 角色:${x.role}`;
          const content = document.createElement('div');
          content.textContent = x.content || '';
          div.appendChild(meta);
          div.appendChild(content);
          stream.appendChild(div);
        });
      timeline.innerHTML = '';
      buffer.forEach(x => {
        const t = document.createElement('div');
        t.className = 'item';
        t.textContent = `${x.timestamp} ▶ ${x.model} → ${x.role}`;
        timeline.appendChild(t);
      });
      stream.scrollTop = stream.scrollHeight;
      timeline.scrollTop = timeline.scrollHeight;
    }

    ws.onopen = () => { status.textContent = '已连接'; };
    ws.onclose = () => { status.textContent = '连接断开'; };
    ws.onmessage = (ev) => {
      try {
        const data = JSON.parse(ev.data);
        buffer.push(data);
        render();
      } catch {}
    };
    q.oninput = render;
    typeSel.onchange = render;
    exportBtn.onclick = () => {
      const blob = new Blob([JSON.stringify(buffer, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'monitor-outputs.json';
      a.click();
      URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
